{% extends 'base.html' %}

{% block title %}
  Books
{% endblock %}

{% block style %}
<style>
  /* Darker green color */
  :root {
    --dark-green: #165c26;
    --light-green-bg: #e8f5e9;
  }

  /* Table header */
  thead.table-dark-green th {
    background-color: var(--dark-green);
    color: white;
    border-color: var(--dark-green);
  }

  /* Buttons green theme */
  .btn-dark-green {
    background-color: var(--dark-green);
    color: white;
    border: none;
  }

  .btn-dark-green:hover,
  .btn-dark-green:focus {
    background-color: #144e20;
    color: white;
  }

  /* Reserved badge styling if needed */
  .badge-reserved {
    background-color: var(--dark-green);
    color: white;
    font-weight: 600;
  }

  /* Responsive table wrapper */
  .table-responsive {
    overflow-x: auto;
    margin-top: 1rem;
  }

  /* Smaller spacing for buttons group in action column */
  td.action > button {
    margin-right: 0.25rem;
    margin-bottom: 0.25rem;
  }

  /* Center "No book available" message */
  .empty-text {
    margin-top: 2rem;
    font-size: 1.25rem;
    color: var(--dark-green);
    font-weight: 500;
  }
</style>
{% endblock %}

{% block content %}

  {% with available_books=books_for_sale, endpoint='transactions_bp.sell_book', form=book_form %}
    {% include 'transactions/sell_book_modal.html' %}
  {% endwith %}

  {% include 'books/add_book_modal.html' %}
  {% include 'transactions/return_book_modal.html' with context %}
  {% include 'import-books-frappe.html' %}
  {% include 'transactions/borrow_book_modal.html' %}

  <div class="d-flex flex-wrap gap-2 mb-3">
    <button type="button" class="btn btn-dark-green" data-bs-toggle="modal" data-bs-target="#bookModal">
      Create
    </button>

    <button type="button" class="btn btn-dark-green" data-bs-toggle="modal" data-bs-target="#returnBookModal">
      Return
    </button>
  </div>

  {% if books|length > 0 %}
    <div class="table-responsive">
      <table class="table table-striped align-middle">
        <thead class="table-dark-green">
          <tr>
            <th scope="col" class="table-id">ID</th>
            <th scope="col">Name</th>
            <th scope="col">ISBN</th>
            <th scope="col">Author</th>
            <th scope="col">Category</th>
            <th scope="col">Price</th>
            <th scope="col">Stock</th>
            <th scope="col" class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for book in books %}
            {% include 'books/delete_book_modal.html' %}
            {% include 'books/update_book_modal.html' %}
            <tr>
              <th scope="row" class="table-id">{{ book.id }}</th>
              <td>{{ book.title }}</td>
              <td>{{ book.isbn }}</td>
              <td>{{ book.author }}</td>
              <td>{{ book.category }}</td>
              <td>${{ "%.2f"|format(book.price) }}</td>
              <td>{{ book.borrow_stock }}</td>
              <td class="action text-center">
                <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteModal-{{ book.id }}">
                  Delete
                </button>

                <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#updateBookModal-{{ book.id }}">
                  Update
                </button>

                {% if book.borrow_stock > 0 %}
                  <button type="button" class="btn btn-primary btn-sm"
                          data-bs-toggle="modal"
                          data-bs-target="#borrowBookModal"
                          data-book-id="{{ book.id }}">
                    Borrow
                  </button>

                  <button type="button" class="btn btn-success btn-sm"
                          data-bs-toggle="modal"
                          data-bs-target="#sellBookModal"
                          data-book-id="{{ book.id }}"
                          data-book-title="{{ book.title }}"
                          data-book-price="{{ book.price }}">
                    Sell
                  </button>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="empty-text text-center">No book Available</div>
  {% endif %}

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const borrowModal = document.getElementById('borrowBookModal');
      borrowModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const bookId = button.getAttribute('data-book-id');
        if (bookId) {
          document.getElementById('book_name').value = bookId;
        }
      });
    });
  </script>

{% endblock %}
